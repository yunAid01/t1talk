# infra/nginx/nginx.conf

events {
    # 한 번에 처리할 수 있는 접속 수 (기본값 유지)
    worker_connections 1024;
}

http {
    # 1. 우리 선수들(컨테이너) 소개
    # docker-compose.yml에 적을 '서비스 이름'과 '내부 포트'를 적습니다.
    
    upstream client {
        server web:3010;  # Next.js 컨테이너
    }

    upstream backend {
        server api:3009;  # NestJS 컨테이너 (포트가 3000이면 3000으로 수정)
    }

    server {
        listen 80; # Nginx는 80번 포트에서 손님을 기다립니다.

        # 2. /api 로 시작하는 요청 (백엔드 API)
        # 예: http://localhost/api/auth/login
        location /api {
            proxy_pass http://backend; # NestJS로 토스!
            
            # 헤더 설정 (백엔드가 누가 요청했는지 알 수 있게)
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # 3. /socket.io 로 시작하는 요청 (실시간 채팅)
        # 소켓은 일반 HTTP와 달라서 설정이 좀 더 필요합니다.
        location /socket.io/ {
            proxy_pass http://backend; # 이것도 NestJS로 토스!
            
            # ★ 웹소켓 필수 설정 ★ (이거 없으면 연결 안 됨)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }

        # 4. 나머지 모든 요청 (프론트엔드 페이지)
        # 예: http://localhost/login, http://localhost/chatroom
        location / {
            proxy_pass http://client; # Next.js로 토스!
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}